<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Your Repos - GitClub</title>
    <link rel="stylesheet" href="../style.css" />
  </head>
  <body>
    <header>
      <h1>Your Repos</h1>
    </header>
    <main>
      <div id="app">Loading...</div>
    </main>
    <script type="module">
      import DOMPurify from "https://cdn.jsdelivr.net/npm/dompurify@2.3.10/dist/purify.es.js";
      import { API, STORAGE_KEY } from "../globals.js";

      //
      // Constants
      //

      const app = document.getElementById("app");
      const params = new URLSearchParams(location.search);

      //
      // Functions
      //

      function getJSON(response) {
        if (!response.ok) {
          throw new Error("Something went wrong.");
        }

        return response.json();
      }

      function getRepoHTML(repo) {
        return `
            <article>
              <header>
                <h2>
                  <a href="${repo.html_url}">${repo.name}</a>
                </h2>
                <p>${repo.description}</p>
              </header>
              <ul>
                <li>${repo.stargazers_count} stars</li>
                <li>${repo.watchers_count} watching</li>
                <li>${repo.forks_count} forks</li>
              </ul>
            </article>
          `;
      }

      function render(data) {
        const htmlString = data.map(getRepoHTML).join("");
        app.innerHTML = DOMPurify.sanitize(htmlString);
      }

      function handleError(error) {
        localStorage.removeItem(STORAGE_KEY);
        app.textContent = error.toString();
      }

      function init() {
        let token = localStorage.getItem(STORAGE_KEY);

        if (!token) {
          token = params.get("token");
        }

        if (!token) {
          app.textContent = "No available token.";
          return;
        }

        const request = new Request(API, {
          headers: { Authorization: `token ${token}` },
        });

        localStorage.setItem(STORAGE_KEY, token);

        // prettier-ignore
        fetch(request)
          .then(getJSON)
          .then(render)
          .catch(handleError);
      }

      //
      // Inits
      //

      init();
    </script>
  </body>
</html>
